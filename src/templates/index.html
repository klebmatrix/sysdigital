<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Educacional</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
.section-header { border-left: 5px solid #1d4ed8; padding-left: 1rem; }
.status-ativo { background-color: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; }
.status-expirado { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
.modal-overlay { z-index: 1000; background-color: rgba(0,0,0,0.7);}
</style>
</head>
<body class="p-4 sm:p-8">

<div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">

<!-- ------------------ LOGIN ------------------ -->
<section id="login-section">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-6">ðŸŽ“ Login</h1>
    <form id="form-login" class="space-y-4">
        <input type="email" id="login-email" placeholder="E-mail" required class="w-full p-3 border rounded-lg">
        <input type="password" id="login-senha" placeholder="Senha" required class="w-full p-3 border rounded-lg">
        <select id="login-role" class="w-full p-3 border rounded-lg">
            <option value="admin">Admin</option>
            <option value="professor">Professor</option>
            <option value="aluno">Aluno</option>
        </select>
        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg">Entrar</button>
    </form>
    <p id="login-status" class="mt-2 text-red-500"></p>
</section>

<!-- ------------------ ADMIN ------------------ -->
<section id="admin-section" class="hidden">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-6">Admin</h1>

    <!-- Cadastro Professor -->
    <div class="p-4 bg-gray-50 rounded-lg mb-6">
        <h2 class="text-xl font-semibold mb-2">Cadastrar Professor</h2>
        <input type="email" id="admin-prof-email" placeholder="E-mail" class="w-full p-2 border rounded-lg mb-2">
        <input type="password" id="admin-prof-senha" placeholder="Senha" class="w-full p-2 border rounded-lg mb-2">
        <input type="date" id="admin-prof-expira" class="w-full p-2 border rounded-lg mb-2">
        <button id="btn-cadastrar-prof" class="bg-green-600 text-white py-2 px-4 rounded-lg">Cadastrar</button>
    </div>

    <!-- Lista Professores -->
    <div>
        <h2 class="text-xl font-semibold mb-2">Lista de Professores</h2>
        <table class="min-w-full divide-y divide-gray-200">
            <thead><tr>
                <th>E-mail</th>
                <th>Expira Em</th>
                <th>AÃ§Ã£o</th>
            </tr></thead>
            <tbody id="admin-prof-table"></tbody>
        </table>
    </div>
</section>

<!-- ------------------ PROFESSOR ------------------ -->
<section id="professor-section" class="hidden">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-6">Professor</h1>

    <!-- Cadastro Aluno -->
    <div class="p-4 bg-gray-50 rounded-lg mb-6">
        <h2 class="text-xl font-semibold mb-2">Cadastrar Aluno</h2>
        <input type="email" id="prof-aluno-email" placeholder="E-mail" class="w-full p-2 border rounded-lg mb-2">
        <input type="password" id="prof-aluno-senha" placeholder="Senha" class="w-full p-2 border rounded-lg mb-2">
        <input type="text" id="prof-aluno-turma" placeholder="Turma" class="w-full p-2 border rounded-lg mb-2">
        <button id="btn-cadastrar-aluno" class="bg-green-600 text-white py-2 px-4 rounded-lg">Cadastrar</button>
    </div>

    <!-- Lista Alunos -->
    <div>
        <h2 class="text-xl font-semibold mb-2">Lista de Alunos</h2>
        <table class="min-w-full divide-y divide-gray-200">
            <thead><tr>
                <th>E-mail</th>
                <th>Turma</th>
            </tr></thead>
            <tbody id="prof-aluno-table"></tbody>
        </table>
    </div>
</section>

<!-- ------------------ ALUNO ------------------ -->
<section id="aluno-section" class="hidden">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-6">Aluno</h1>
    <div id="aluno-atividades"></div>
</section>

</div>

<script>
let usuarioAtual = { role:null, email:null };

// ----------------- LOGIN -----------------
document.getElementById('form-login').addEventListener('submit', async e=>{
    e.preventDefault();
    const email = document.getElementById('login-email').value.trim();
    const senha = document.getElementById('login-senha').value.trim();
    const role = document.getElementById('login-role').value;
    
    const resp = await fetch('/api/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({email, senha, role})
    });
    const data = await resp.json();
    if(data.success){
        usuarioAtual = {role, email};
        document.getElementById('login-section').classList.add('hidden');
        if(role==='admin') loadAdmin();
        if(role==='professor') loadProfessor();
        if(role==='aluno') loadAluno();
    } else {
        document.getElementById('login-status').textContent = data.message;
    }
});

// ----------------- ADMIN -----------------
async function loadAdmin(){
    document.getElementById('admin-section').classList.remove('hidden');
    const table = document.getElementById('admin-prof-table');

    async function listarProfessores(){
        const resp = await fetch('/api/admin/listar_professores');
        const data = await resp.json();
        table.innerHTML='';
        data.professores.forEach(p=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${p.email}</td>
                            <td>${p.expira_em}</td>
                            <td><button onclick="excluirProf('${p.email}')"
                                class="bg-red-600 text-white px-2 rounded">Excluir</button></td>`;
            table.appendChild(tr);
        });
    }

    window.excluirProf = async (email)=>{
        await fetch('/api/admin/excluir_professor',{method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({email})
        });
        listarProfessores();
    }

    document.getElementById('btn-cadastrar-prof').onclick = async ()=>{
        const email = document.getElementById('admin-prof-email').value.trim();
        const senha = document.getElementById('admin-prof-senha').value.trim();
        const expira_em = document.getElementById('admin-prof-expira').value;
        await fetch('/api/admin/cadastrar_professor',{method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({email, senha, expira_em})
        });
        listarProfessores();
    }

    listarProfessores();
}

// ----------------- PROFESSOR -----------------
async function loadProfessor(){
    document.getElementById('professor-section').classList.remove('hidden');
    const table = document.getElementById('prof-aluno-table');

    async function listarAlunos(){
        const resp = await fetch(`/api/professor/listar_alunos/${usuarioAtual.email}`);
        const data = await resp.json();
        table.innerHTML='';
        data.alunos.forEach(a=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${a.email}</td><td>${a.turma}</td>`;
            table.appendChild(tr);
        });
    }

    document.getElementById('btn-cadastrar-aluno').onclick = async ()=>{
        const email = document.getElementById('prof-aluno-email').value.trim();
        const senha = document.getElementById('prof-aluno-senha').value.trim();
        const turma = document.getElementById('prof-aluno-turma').value.trim();
        await fetch('/api/professor/cadastrar_aluno',{method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({email, senha, turma, professor:usuarioAtual.email})
        });
        listarAlunos();
    }

    listarAlunos();
}

// ----------------- ALUNO -----------------
async function loadAluno(){
    document.getElementById('aluno-section').classList.remove('hidden');
    const container = document.getElementById('aluno-atividades');
    const resp = await fetch(`/api/aluno/listar_atividades/${usuarioAtual.email}`);
    const data = await resp.json();
    container.innerHTML='<h2 class="text-xl font-semibold mb-2">Atividades DisponÃ­veis</h2>';
    data.atividades.forEach(a=>{
        const div = document.createElement('div');
        div.className='p-3 border rounded mb-2';
        div.innerHTML=`<strong>${a.titulo}</strong> - ${a.tipo}
            <button class="bg-blue-600 text-white px-2 rounded ml-2" onclick="abrirAtividade(${a.id})">Responder</button>`;
        container.appendChild(div);
    });
}

async function abrirAtividade(atividade_id){
    const resp = await fetch(`/api/aluno/listar_questoes/${atividade_id}`);
    const data = await resp.json();
    const container = document.getElementById('aluno-atividades');
    container.innerHTML='<h2 class="text-xl font-semibold mb-2">Responder Atividade</h2>';
    data.questoes.forEach(q=>{
        const div = document.createElement('div');
        div.className='p-3 border rounded mb-2';
        let html = `<p>${q.pergunta}</p>`;
        if(q.alternativas){
            q.alternativas.forEach(opt=>{
                html += `<label><input type="radio" name="q${q.id}" value="${opt}"> ${opt}</label><br>`;
            });
        } else {
            html += `<input type="text" id="q${q.id}" class="border p-1 w-full mb-2">`;
        }
        html += `<button onclick="responderQuestao(${q.id})" class="bg-green-600 text-white px-2 rounded">Enviar</button>`;
        div.innerHTML = html;
        container.appendChild(div);
    });
}

async function responderQuestao(questao_id){
    let resposta = '';
    const radios = document.querySelectorAll(`input[name="q${questao_id}"]`);
    if(radios.length>0){
        radios.forEach(r=>{if(r.checked) resposta=r.value});
    } else {
        resposta = document.getElementById(`q${questao_id}`).value.trim();
    }
    const resp = await fetch('/api/aluno/responder',{method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({aluno:usuarioAtual.email, questao_id, resposta})
    });
    const data = await resp.json();
    alert(data.acerto ? 'Acertou!' : 'Errou');
}
</script>
</body>
</html>
