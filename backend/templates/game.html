<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Neural Relationship Game</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  html, body {margin:0; padding:0; height:100%; background:#071019; color:#fff; font-family:Arial,sans-serif; overflow:hidden;}
  #topbar {position:fixed; top:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.5); padding:8px 12px; border-radius:8px; z-index:10;}
  #topbar .title {font-weight:700; margin-right:10px;}
  #status {font-weight:bold; margin-left:8px;}
  #light {width:14px; height:14px; border-radius:50%; display:inline-block; background:red; margin-left:8px; vertical-align:middle; box-shadow:0 0 10px #400;}
  #progress {margin-left:12px;}
  #log {position:fixed; top:70px; left:50%; transform:translateX(-50%); width:60%; max-height:220px; overflow:auto; background:rgba(0,0,0,0.35); border-radius:8px; padding:10px; font-size:13px; z-index:9;}
  #controls {position:fixed; bottom:14px; left:50%; transform:translateX(-50%); display:flex; gap:8px; z-index:10;}
  button {background:#0b5566; border:none; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer;}
  button:hover {background:#0e7386;}
  svg {width:100vw; height:100vh; display:block;}
  .node text {pointer-events:none; fill:#fff; font-weight:700; font-size:12px; text-anchor:middle;}
</style>
</head>
<body>

<div id="topbar">
  <span class="title">N√≠vel: <strong>{{ payload.name }}</strong></span>
  <span id="status">üîµ Conecte as rela√ß√µes corretas</span>
  <span id="light"></span>
  <span id="progress">0 / {{ payload.relations|length }}</span>
  <a href="/"><button>Voltar</button></a>
</div>

<div id="log"></div>

<div id="controls">
  <button id="clearBtn">üîÅ Limpar</button>
  <button id="centerBtn">üéØ Recentralizar</button>
  <button id="newBtn">üîÑ Novo Jogo</button>
</div>

<svg id="svgroot"></svg>

<script>
const PAYLOAD = {{ payload|tojson }};

const canonicalSet = new Set();
const canonicalToText = {};
PAYLOAD.relations.forEach(r => {
  const a = r.pair[0], b = r.pair[1];
  const key = [a,b].sort().join("||");
  canonicalSet.add(key);
  canonicalToText[key] = r.text;
});

const width = window.innerWidth, height = window.innerHeight;
const svg = d3.select("#svgroot");

let nodes = PAYLOAD.entities.map(id => ({id, fx:null, fy:null}));
let links = [];
let selectedNode = null;
let foundCount = 0;

const simulation = d3.forceSimulation(nodes)
  .force("link", d3.forceLink(links).id(d=>d.id).distance(160).strength(1))
  .force("charge", d3.forceManyBody().strength(-60))
  .force("collide", d3.forceCollide(36))
  .force("center", d3.forceCenter(width/2, height/2))
  .alphaDecay(0.02)
  .velocityDecay(0.7);

const gLinks = svg.append("g");
const gNodes = svg.append("g");

function update() {
  const linkSel = gLinks.selectAll("line").data(links, d=>d.uid);
  linkSel.join(
    enter => enter.append("line")
      .attr("stroke-width", 3)
      .attr("stroke", d => d.correct ? "#00FF66" : "#888")
      .attr("opacity", 0.95),
    update => update.attr("stroke", d => d.correct ? "#00FF66" : "#888"),
    exit => exit.remove()
  );

  const labelSel = gLinks.selectAll("text").data(links.filter(d=>d.correct), d=>d.uid);
  labelSel.join(
    enter => enter.append("text")
      .text(d => d.text)
      .attr("font-size", 12)
      .attr("fill", "#cde")
      .attr("text-anchor","middle"),
    update => update.text(d => d.text),
    exit => exit.remove()
  );

  const nodeSel = gNodes.selectAll("g.node").data(nodes, d=>d.id);
  nodeSel.join(
    enter => {
      const g = enter.append("g").attr("class","node").call(drag(simulation));
      g.append("circle").attr("r",28).attr("fill","#11698e").attr("stroke","#0b3b4a").attr("stroke-width",2)
        .on("click", (event,d)=> nodeClicked(d));
      g.append("text").attr("dy",5).text(d=>d.id);
      return g;
    },
    update => update,
    exit => exit.remove()
  );

  simulation.nodes(nodes);
  simulation.force("link").links(links);
  simulation.alpha(0.6).restart();
}

function drag(sim) {
  function started(event,d) { if(!event.active) sim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
  function dragged(event,d){ d.fx = event.x; d.fy = event.y; }
  function ended(event,d){ if(!event.active) sim.alphaTarget(0); }
  return d3.drag().on("start",started).on("drag",dragged).on("end",ended);
}

function nodeClicked(node) {
  if(!selectedNode) { selectedNode = node; highlightNode(node.id,true); return; }
  if(selectedNode.id === node.id) { highlightNode(node.id,false); selectedNode = null; return; }

  const a = selectedNode.id, b = node.id;
  const key = [a,b].sort().join("||");

  // n√£o repetir liga√ß√µes
  const alreadyLinked = links.some(l =>
    (l.source.id === a && l.target.id === b) || (l.source.id === b && l.target.id === a)
  );
  if(alreadyLinked) { logMsg("‚ö†Ô∏è Liga√ß√£o j√° existente entre " + a + " e " + b); highlightNode(selectedNode.id,false); selectedNode = null; return; }

  const isCorrect = canonicalSet.has(key);
  const text = isCorrect ? canonicalToText[key] : "";
  const uid = a + "||" + b + "||" + Date.now();
  links.push({uid, source:a, target:b, correct:isCorrect, text});

  if(isCorrect) { foundCount++; logMsg("üü¢ " + text, "#aaffc3"); }
  else { logMsg("üî¥ Liga√ß√£o incorreta entre " + a + " e " + b, "#ff8888"); }

  highlightNode(selectedNode.id,false);
  selectedNode = null;
  update();
  updateProgress();
  checkWin();
}

function highlightNode(id,on) {
  gNodes.selectAll("g.node").select("circle")
    .attr("stroke", d => (d.id===id && on) ? "#ffd166" : "#0b3b4a")
    .attr("stroke-width", d => (d.id===id && on) ? 4 : 2);
}

function logMsg(text,color="#ccc") {
  const log = document.getElementById("log");
  const p = document.createElement("div");
  p.textContent = text;
  p.style.color = color; p.style.padding = "3px 0";
  log.appendChild(p);
  log.scrollTop = log.scrollHeight;
}

function updateProgress(){
  document.getElementById("progress").textContent = foundCount + " / " + PAYLOAD.relations.length;
}

function checkWin(){
  if(foundCount === PAYLOAD.relations.length){
    document.getElementById("status").textContent = "üü¢ Todas as rela√ß√µes corretas encontradas!";
    document.getElementById("light").style.background = "#00ff00";
    document.getElementById("light").style.boxShadow = "0 0 20px #0f0";
  } else {
    document.getElementById("light").style.background = "red";
    document.getElementById("light").style.boxShadow = "0 0 10px #400";
  }
}

function clearConnections(){
  links = [];
  selectedNode = null;
  foundCount = 0;
  document.getElementById("status").textContent = "üîµ Conecte as rela√ß√µes corretas";
  document.getElementById("light").style.background = "red";
  document.getElementById("light").style.boxShadow = "0 0 10px #400";
  document.getElementById("log").innerHTML = "";
  update();
  updateProgress();
}

function centerNodes(){
  const cx = width/2;
  const cy = height/2;
  nodes.forEach((n,i)=>{
    n.fx = null;
    n.fy = null;
    n.x = cx + 150 * Math.cos((2*Math.PI/nodes.length)*i);
    n.y = cy + 150 * Math.sin((2*Math.PI/nodes.length)*i);
  });
  simulation.alpha(1).restart();
}

function newGame(){
  clearConnections();
  nodes.forEach(n => { n.x = Math.random()*width; n.y = Math.random()*height; });
  simulation.alpha(0.9).restart();
}

simulation.on("tick", () => {
  gLinks.selectAll("line")
    .attr("x1", d => getNode(d.source).x)
    .attr("y1", d => getNode(d.source).y)
    .attr("x2", d => getNode(d.target).x)
    .attr("y2", d => getNode(d.target).y);

  gLinks.selectAll("text")
    .attr("x", d => (getNode(d.source).x + getNode(d.target).x)/2)
    .attr("y", d => (getNode(d.source).y + getNode(d.target).y)/2);

  gNodes.selectAll("g.node")
    .attr("transform", d => `translate(${d.x},${d.y})`);
});

function getNode(id){ return nodes.find(n=>n.id===id); }

update();
updateProgress();
checkWin();

document.getElementById("clearBtn").addEventListener("click", clearConnections);
document.getElementById("centerBtn").addEventListener("click", centerNodes);
document.getElementById("newBtn").addEventListener("click", newGame);
</script>
</body>
</html>
